---
title: 移动端最佳适配方案
date: 2022-08-04 16:03:10
cover: 'https://picx.zhimg.com/v2-c267563cb186c371f7db75133599eeae_1440w.jpg?source=172ae18b'
tags:
- 移动端
- 适配
- viewport
---

{% blockquote %}
由于viewport单位得到众多浏览器的兼容，lib-flexible这个过渡方案已经可以放弃使用，不管是现在的版本还是以前的版本，都存有一定的问题。建议大家开始使用viewport来替代此方案。
{% endblockquote %}
### viewport背景
- 手机浏览器默认为我们做两件事情
    - 页面渲染在一个980px(IOS)的viewport（安卓viewport宽度不固定）
    - 如果不用viewport直接缩放，排版就会乱掉，所以为了排版正确，伪造了一个980的布局viewport
手机屏幕分为两层，底层是布局viewport(980px)负责渲染页面，上层是我们通过缩放控制的视口viewport
layout viewport:布局viewport 查看layout viewport: document.body.clientWidth
visual viewport:视口/度量viewport 查看visual viewport：window.innerWidth

### viewport的单位vw、vh
vw、vh将viewport分成了一百份。vw: viewport width; vh: viewport height
假如设计稿的视图为375px，那么1vw就等于3.75px，100vw就相当于100%，即window.innerWidth

<b>适配流程如下：</b>
这里以一个vue-cli初始化项目为例：
```html
<!-- @/index.html 的head标签中添加 -->
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
```
`postcss-px-to-viewport`将px单位转换为vw、vh
```bash
$ npm i postcss-px-to-viewport -D
```
在项目根目录新建postcss.config.js配置postcss相关插件信息
```javascript
module.exports = {
    plugins: {
        autoprefixer: {},                // 用来给不同的浏览器自动添加相应前缀，如-webkit-，-moz-等等
        "postcss-px-to-viewport": {
            unitToConvert: "px",         // 被转化的单位
            viewportWidth: 750,          // ui设计稿的宽度
            unitPrecision: 6,            // 转换后的精度 即小数点位数
            propList: ["*"],             // 指定转换的css属性的单位，*代表全部css属性的单位都进行转换
            viewportUnit: "vw",          // 指定需要转换成的视窗单位，默认vw
            fontViewportUnit: "vw",      // 指定字体需要转换成的视窗单位，默认vw
            selectorBlackList: ["wrap"], // 指定不转换为视窗单位的类名
            minPixelValue: 1,            // 默认值1，小于或等于1px则不进行转换
            mediaQuery: true,            // 是否在媒体查询的css代码中也进行转换，默认false
            replace: true,               // 是否转换后直接更换属性值
            exclude: [/node_modules/],   // 设置忽略文件，用正则做目录名匹配
            landscape: false             // 是否处理横屏情况
        }
    }
}
```
- 可能需要二次配置的属性
    - propList
    当有些属性的单位我们不希望转换的时候，可以添加在数组后面，并在前面加上!号，如propList: ["*","!letter-spacing"]，这表示：所有css属性的属性的单位都进行转化，除了letter-spacing的

值得注意的是:postcss-px-to-viewport 同样存在第三方组件库`兼容性的问题`。比如在设计稿为750px时使用vant组件库会将vant组件的样式缩小。

### 解决第三方组件库兼容问题
如vant组件库的设计稿是按照375px来开发的。vant官网关于viewport的适配方案，在github找一个名为vant-demo的项目，可以看到其配置如下
<script src="https://github.com/vant-ui/vant-demo/blob/master/vant/viewport/vue.config.js"></script>
因此在viewportWidth为通常的750px时会出现转换问题。
解决：
```javascript
// postcss.config.js
const path = require('path');
module.exports = ({webpack}) => {  // 改为输出函数的形式，这样可以拿到webpack运行的当前执行文件的信息
    // 这里使用path.join('node_modules', 'vant')是因为适应不同的操作系统，在mac下结果为node_modules/vant，而在windows下结果为node_modules\vant
    const viewWidth = webpack.resourcePath.includes(path.join('node_modules', 'vant')) ? 375 : 750;
    return {
        plugins: {
            autoprefixer: {},
            "postcss-px-to-viewport": {
                unitToConvert: "px",
                viewportWidth: viewWidth, // 如果读取的node_modules中的文件是vant,那么就将设计稿变为375px,否则就将设计稿变为750px
                unitPrecision: 6,
                propList: ["*"],
                viewportUnit: "vw",
                fontViewportUnit: "vw",
                selectorBlackList: [],
                minPixelValue: 1,
                mediaQuery: true,
                exclude: [],              // 去掉/node_modules/, 表示全部内容进行vw转换
                landscape: false 
            }
        }
  }
}
```